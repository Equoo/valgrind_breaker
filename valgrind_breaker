#!/usr/bin/env bash

set -euo pipefail

VALGRIND_BIN="/home/dderny/Documents/valgrind_breaker/vg-in-place"

MAGENTA='\033[1;35m'
RESET='\033[0m'

########################################
# Run Valgrind wrapper
########################################
run_valgrind() {
    "$VALGRIND_BIN" "$@"
}

########################################
# Extract argument value from CLI
########################################
extract_arg_value() {
    local pattern="$1"
    echo "$@" | grep -oP "$pattern" || true
}

########################################
# Clean malloc auto arguments
########################################
strip_malloc_auto_args() {
    local args=("$@")

    args=("${args[@]/--malloc-fail-auto/}")
    args=("${args[@]/$(echo "${args[*]}" | grep -oP '\-\-malloc-fail-start=\d+')/}")
    args=("${args[@]/$(echo "${args[*]}" | grep -oP '\-\-malloc-fail-max=\d+')/}")

    echo "${args[@]}"
}

########################################
# Capture stdin if piped
########################################
capture_stdin() {
    if [ ! -t 0 ]; then
        STDIN_FILE=$(mktemp)
        cat > "$STDIN_FILE"
        export STDIN_FILE
    fi
}

########################################
# Get malloc breakable count from XML
########################################
get_malloc_count() {
    local xml_file="$1"

    sed -n \
        's:.*<malloc_breakable_count>\(.*\)</malloc_breakable_count>.*:\1:p' \
        "$xml_file" | sed 's/,//g'
}

########################################
# Extract effective leak count
########################################
get_effective_leaks() {
    local xml_file="$1"

    local total
    local suppressed

    total=$(xmllint --xpath \
        'sum(//leak_summary/leak/xwhat/leakedblocks)' \
        "$xml_file" 2>/dev/null || echo 0)

    suppressed=$(xmllint --xpath \
        'sum(//leak_summary/leak[kind="suppressed"]/xwhat/leakedblocks)' \
        "$xml_file" 2>/dev/null || echo 0)

    total=${total:-0}
    suppressed=${suppressed:-0}

    printf "%.0f" "$(echo "$total - $suppressed" | bc)"
}

########################################
# Extract errorcounts block
########################################
get_error_counts() {
    local xml_file="$1"

	if [[ $(xmllint --xpath \
		'string(//errorcounts)' \
		"$xml_file") == "" ]]; then
		echo 0
	else
		echo 1
	fi
}

########################################
# Run one malloc failure test
########################################
run_single_malloc_fail_test() {
    local fail_index="$1"
    shift
    local cmd=("$@")

    echo "Running Valgrind with --malloc-fail-at=$fail_index"

    local xml_output
    xml_output=$(mktemp)

    run_valgrind \
        --tool=memcheck \
        --leak-check=full \
        --track-origins=yes \
        --show-leak-kinds=all \
        --xml=yes \
        --xml-file="$xml_output" \
        --malloc-fail-at="$fail_index" \
        "${cmd[@]}" \
        ${STDIN_FILE:+< "$STDIN_FILE"} \
        >/dev/null 2>/dev/null

    local exit_code=$?

    if [[ $exit_code -eq 139 ]]; then
        echo -e "${MAGENTA}SIGSEGV detected at malloc-fail=$fail_index${RESET}"
        rm -f "$xml_output"
        return
    fi

    local effective_leaks
    effective_leaks=$(get_effective_leaks "$xml_output")

    local error_counts
    error_counts=$(get_error_counts "$xml_output")

    if [[ "$effective_leaks" != "0" ]]; then
        echo -e "${MAGENTA}Memory leak detected at malloc-fail=$fail_index${RESET}"
    fi

    if [[ "$error_counts" != "0" ]]; then
        echo -e "${MAGENTA}Errors detected at malloc-fail=$fail_index${RESET}"
    fi

    rm -f "$xml_output"
}

########################################
# Detect malloc count
########################################
detect_malloc_count() {
    local xml_output
    xml_output=$(mktemp)

    run_valgrind \
        --tool=memcheck \
        --xml=yes \
        --xml-file="$xml_output" \
        --malloc-fail-count=yes \
        "${TARGET_COMMAND[@]}" \
        ${STDIN_FILE:+< "$STDIN_FILE"} \
        >/dev/null 2>&1

    local malloc_count
    malloc_count=$(get_malloc_count "$xml_output")

    rm -f "$xml_output"

    if [[ -z "$malloc_count" ]]; then
        echo "Failed to detect malloc count."
        exit 1
    fi

    echo "$malloc_count"
}

########################################
# Main
########################################

if [[ " $* " == *" --malloc-fail-auto "* ]]; then

    MIN_FAIL=$(extract_arg_value '(?<=--malloc-fail-start=)\d+' "$@")
    MAX_FAIL=$(extract_arg_value '(?<=--malloc-fail-max=)\d+' "$@")

    MIN_FAIL=${MIN_FAIL:-1}
    MAX_FAIL=${MAX_FAIL:-0}

    TARGET_COMMAND=($(strip_malloc_auto_args "$@"))

    capture_stdin

    MALLOC_COUNT=$(detect_malloc_count)
    echo "Number of mallocs detected: $MALLOC_COUNT"

    if (( MAX_FAIL < MALLOC_COUNT )); then
        MAX_FAIL=$MALLOC_COUNT
    fi

    export -f run_valgrind
    export -f run_single_malloc_fail_test
    export -f get_effective_leaks
    export -f get_error_counts

    export TARGET_COMMAND
	export VALGRIND_BIN
    export STDIN_FILE

    seq "$MIN_FAIL" "$MAX_FAIL" | \
	xargs -P "$(nproc)" -I{} bash -c '
		fail_index="$1"
		shift
		run_single_malloc_fail_test "$fail_index" "$@"
	' _ {} "${TARGET_COMMAND[@]}"

    rm -f "${STDIN_FILE:-}"

else
    run_valgrind "$@"
fi
